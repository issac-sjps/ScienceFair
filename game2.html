<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>口說挑戰</title>
<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(180deg,#0b1220,#1e1b4b);
  color:#fff;
}
.header-block{
  width:100%;
  padding:16px 24px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(8px);
  text-align:center;
}
.header-block h1{
  margin:0 0 8px 0;
}
.stats{
  display:flex;
  gap:16px;
  justify-content:center;
  margin-bottom:8px;
  color:#94a3b8;
}
#rankBoard{
  width:90%;
  background:rgba(0,0,0,0.6);
  border-radius:12px;
  padding:0 0 12px 0;
  margin:12px auto;
  max-height:180px;
  overflow-y:auto;
}
#rankBoard h3{
  margin:0;
  padding:8px 12px;
  font-size:22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
#rankList{
  list-style:none;
  padding:0;
  margin:0;
}
#rankList li{
  padding:4px 12px;
}
main{
  display:flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap:16px;
  width: 100%;
  max-width:800px;
  padding-bottom:120px;
  margin:20px auto;
  text-align:center;
}
#clue{
  margin:16px 0;
  font-size:20px;
  color:#94a3b8;
}
.button-group{
  display:flex;
  gap:16px;
  justify-content:center;
  flex-wrap:wrap;
}
button{
  padding:10px 20px;
  margin:4px;
  font-size:18px;
  border:none;
  border-radius:10px;
  background:linear-gradient(90deg,#6366f1,#a78bfa);
  color:#fff;
  cursor:pointer;
}
button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}
.result{
  font-size:20px;
  margin-top:8px;
  padding:6px 12px;
  border-radius:10px;
}
.result.good{
  background:rgba(34,197,94,0.15);
  color:#22c55e;
}
.result.bad{
  background:rgba(239,68,68,0.15);
  color:#ef4444;
}
footer{
  width:100%;
  padding:12px;
  background:rgba(0,0,0,0.3);
  backdrop-filter:blur(8px);
}
</style>
</head>
<body>

<div class="header-block">
<h1>高雄捷運 雙語同行 磁力迷宮 復古探險</h1>
<h2>Bilingual Kaohsiung Metro  Magnetic Maze Retro</h2>
<h1>口說挑戰</h1>
<div class="stats">分數：<span id="score">0</span> | 答對率：<span id="accuracy">0</span>% | 時間：<span id="timer">0</span>s</div>
<div id="rankBoard">
<h3>🏆 排行榜</h3>
<ol id="rankList"></ol>
</div>
</div>

<main>
<div id="clue">請按「開始挑戰」</div>
<div class="button-group">
<button id="startBtn">開始挑戰</button>
<button id="recBtn">按下說話</button>
<button id="nextBtn">下一題</button>
<button id="playRef">播放單字</button>
</div>
<div id="feedback"></div>
<div id="userSpeech"></div>
</main>

<footer>⏱️ 口說挑戰 — iPad 全螢幕</footer>

<script>
const qa=[
  {prompt:'磁鐵', answer:'magnet'},
  {prompt:'北極', answer:'north pole'},
  {prompt:'南極', answer:'south pole'},
  {prompt:'推開', answer:'push away'},
  {prompt:'拉在一起', answer:'pull together'}
];

let idx=0,score=0,totalCount=0,correctCount=0,isRecording=false,trialsLeft=5,startTime=0;
const scoreEl=document.getElementById('score');
const accuracyEl=document.getElementById('accuracy');
const timerEl=document.getElementById('timer');
const clue=document.getElementById('clue');
const feedback=document.getElementById('feedback');
const userSpeech=document.getElementById('userSpeech');
const recBtn=document.getElementById('recBtn');
const startBtn=document.getElementById('startBtn');
const nextBtn=document.getElementById('nextBtn');
const playRef=document.getElementById('playRef');
const rankList=document.getElementById('rankList');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition=null;
let timerInterval=null;

if(SpeechRecognition){
  recognition=new SpeechRecognition();
  recognition.lang='en-US';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.addEventListener('result', e=>{
    const txt=e.results[0][0].transcript.trim();
    const ref=qa[idx].answer.toLowerCase().replace(/ /g,'');
    const userInput=txt.toLowerCase().replace(/ /g,'');

    // 顯示系統偵測文字
    userSpeech.innerHTML=`你唸出來聽起來像: <strong>${txt}</strong>`;

    let isCorrect = userInput===ref;
    totalCount++;
    trialsLeft--;
    if(isCorrect){
      correctCount++; score+=20;
      feedback.innerHTML=`<div class="result good">✅ 正確！</div>`;
      recBtn.disabled=true;
    } else {
      feedback.innerHTML=`<div class="result bad">❌ 錯誤! 剩餘次數: ${trialsLeft}</div>`;
      if(trialsLeft>0){
        setTimeout(()=>speakWord(qa[idx].answer),500);
      } else {
        recBtn.disabled=true;
      }
    }
    updateStats();
  });

  recognition.addEventListener('end', ()=>{
    isRecording=false;
    recBtn.textContent='按下說話';
  });

  recognition.addEventListener('error', e=>{
    console.error(e);
    feedback.innerHTML='⚠️ 語音辨識失敗，請再試一次';
    isRecording=false;
    recBtn.textContent='按下說話';
  });
}else{
  recBtn.disabled=true;
  recBtn.textContent='此瀏覽器不支援語音辨識';
}

function updateStats(){
  scoreEl.textContent=score;
  const rate=Math.floor(totalCount>0? (correctCount/totalCount*100):0);
  accuracyEl.textContent=rate;
}

function showQuestion(){
  const q=qa[idx];
  trialsLeft=5;
  feedback.innerHTML='';
  userSpeech.innerHTML='';
  recBtn.disabled=false;
  clue.innerHTML=`<div><strong>中文題是:</strong> ${q.prompt}</div>
                  <div><strong>英文題是:</strong> ${q.answer}</div>`;
  speakWord(q.answer);
}

function speakWord(text){
  if('speechSynthesis' in window){
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
}

startBtn.addEventListener('click', ()=>{
  idx=0; score=0; totalCount=0; correctCount=0; startTime=Date.now();
  updateStats();
  showQuestion();
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{ timerEl.textContent=Math.floor((Date.now()-startTime)/1000); },1000);
});

recBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!isRecording){
    recognition.start();
    isRecording=true;
    recBtn.textContent='錄音中...再按一次停止';
  } else {
    recognition.stop();
  }
});

nextBtn.addEventListener('click', ()=>{
  idx++;
  if(idx>=qa.length){
    finishChallenge();
  } else {
    showQuestion();
  }
});

playRef.addEventListener('click', ()=>{ speakWord(qa[idx].answer); });

function saveRank(name,sc,t){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  recs.push({name,sc,t,date:new Date().toLocaleString()});
  recs.sort((a,b)=>b.sc-a.sc || a.t-b.t);
  localStorage.setItem('speaking_rank',JSON.stringify(recs.slice(0,15)));
  renderRank();
}

function renderRank(){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  rankList.innerHTML=recs.map((r,i)=>`<li>No.${i+1} ${r.name}: ${r.sc}分 / ${r.t}s</li>`).join('');
}

function finishChallenge(){
  clearInterval(timerInterval);
  const totalTime=Math.floor((Date.now()-startTime)/1000);
  const name=prompt(`挑戰完成！分數: ${score} 分，時間: ${totalTime} 秒\n請輸入名字:`,'Player');
  saveRank(name||'匿名',score,totalTime);
  idx=0; score=0; totalCount=0; correctCount=0;
  timerEl.textContent=0;
  updateStats();
  showQuestion();
}

renderRank();
</script>
</body>
</html>
