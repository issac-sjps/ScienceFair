<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>口說挑戰 - 可錄音版</title>
<style>
body{font-family:'Segoe UI',sans-serif;background:#0b1220;color:#fff;text-align:center;margin:0;padding:0;display:flex;flex-direction:column;align-items:center;}
.header{width:100%;padding:16px;background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);}
.header h1{margin:0 0 8px 0;}
.stats{display:flex;gap:16px;justify-content:center;}
button{padding:10px 20px;margin:4px;font-size:18px;border:none;border-radius:10px;background:linear-gradient(90deg,#6366f1,#a78bfa);color:#fff;cursor:pointer;}
button:disabled{opacity:0.6;cursor:not-allowed;}
#clue{margin:16px 0;font-size:20px;}
#feedback{margin:12px;font-size:18px;}
#rankBoard{width:90%;background:rgba(0,0,0,0.6);border-radius:12px;padding:0 0 12px 0;margin-top:12px;max-height:200px;overflow-y:auto;transition:max-height 0.3s;}
#rankBoard.collapsed{max-height:40px;overflow:hidden;}
#rankBoard h3{margin:0;padding:8px 12px;font-size:22px;display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
#rankList{list-style:none;padding:0;margin:0;}
#rankList li{padding:4px 12px;}
.result{font-size:22px;margin-top:12px;padding:8px 16px;border-radius:10px;}
.result.good{background:rgba(34,197,94,0.15);color:#22c55e;}
.result.bad{background:rgba(239,68,68,0.15);color:#ef4444;}
footer{width:100%;padding:12px;background:rgba(0,0,0,0.3);backdrop-filter:blur(8px);}
</style>
</head>
<body>

<div class="header">
<h1>口說挑戰 - 可錄音版</h1>
<div class="stats">分數：<span id="score">0</span> | 答對率：<span id="accuracy">0</span>%</div>
<div id="clue">請按「開始挑戰」</div>
</div>

<div>
<button id="startBtn">開始挑戰</button>
<button id="recBtn">按下說話</button>
<button id="nextBtn">下一題</button>
<button id="playRef">播放單字</button>
</div>

<div id="feedback"></div>

<div id="rankBoard" class="collapsed">
<h3>🏆 排行榜 <span id="toggleRank">📌</span></h3>
<ol id="rankList"></ol>
</div>

<footer>⏱️ 口說挑戰 — iPad 全螢幕</footer>

<script>
const qa=[
  {prompt:'磁鐵', answer:'magnet'},
  {prompt:'北極', answer:'north pole'},
  {prompt:'南極', answer:'south pole'},
  {prompt:'推開', answer:'push away'},
  {prompt:'拉在一起', answer:'pull together'}
];

let idx=0,score=0,totalCount=0,correctCount=0,isRecording=false;
const scoreEl=document.getElementById('score');
const accuracyEl=document.getElementById('accuracy');
const clue=document.getElementById('clue');
const feedback=document.getElementById('feedback');
const recBtn=document.getElementById('recBtn');
const startBtn=document.getElementById('startBtn');
const nextBtn=document.getElementById('nextBtn');
const playRefBtn=document.getElementById('playRef');
const rankBoard=document.getElementById('rankBoard');
const rankList=document.getElementById('rankList');
const toggleRank=document.getElementById('toggleRank');

// 語音辨識
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition=null;

if(SpeechRecognition){
  recognition=new SpeechRecognition();
  recognition.lang='en-US';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.addEventListener('result', e=>{
    const txt=e.results[0][0].transcript.trim().toLowerCase().replace(/ /g,'');
    const ref=qa[idx].answer.toLowerCase().replace(/ /g,'');
    let isCorrect = txt===ref;
    totalCount++;
    if(isCorrect){ correctCount++; score+=20; }
    feedback.innerHTML=`<div class="result ${isCorrect?'good':'bad'}">${isCorrect?'✅ 正確':'❌ 錯誤'}</div><div>你說: ${txt}</div>`;
    updateStats();
  });

  recognition.addEventListener('end', ()=>{
    isRecording=false;
    recBtn.textContent='按下說話';
  });

  recognition.addEventListener('error', e=>{
    console.error(e);
    feedback.innerHTML='⚠️ 語音辨識失敗，請再試一次';
    isRecording=false;
    recBtn.textContent='按下說話';
  });
} else {
  recBtn.disabled=true;
  recBtn.textContent='此瀏覽器不支援語音辨識';
}

// 更新統計
function updateStats(){
  scoreEl.textContent=score;
  const rate=Math.floor(totalCount>0? (correctCount/totalCount*100):0);
  accuracyEl.textContent=rate;
}

// 顯示題目
function showQuestion(){
  const q=qa[idx];
  clue.innerHTML=`中文提示: ${q.prompt} <br>英文提示: ${q.answer}`;
  feedback.innerHTML='';
}

// 播放單字
playRefBtn.addEventListener('click', ()=>{
  const text=qa[idx].answer;
  if('speechSynthesis' in window){
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
});

// 開始挑戰
startBtn.addEventListener('click', ()=>{
  idx=0; score=0; totalCount=0; correctCount=0;
  updateStats();
  showQuestion();
});

// 錄音
recBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!isRecording){
    recognition.start();
    isRecording=true;
    recBtn.textContent='錄音中...再按一次停止';
  } else {
    recognition.stop();
  }
});

// 下一題
nextBtn.addEventListener('click', ()=>{
  idx=(idx+1)%qa.length;
  showQuestion();
});

// 排行榜存取
function saveRank(name,sc){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  recs.push({name,sc,date:new Date().toLocaleString()});
  recs.sort((a,b)=>b.sc-a.sc);
  localStorage.setItem('speaking_rank',JSON.stringify(recs.slice(0,15)));
  renderRank();
}

function renderRank(){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  rankList.innerHTML=recs.map((r,i)=>`<li>No.${i+1} ${r.name}: ${r.sc}分</li>`).join('');
}

// 排行榜收合
toggleRank.addEventListener('click', ()=>{rankBoard.classList.toggle('collapsed');});

// 初始化排行榜
renderRank();
</script>
</body>
</html>
