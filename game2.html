<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å£èªªæŒ‘æˆ°</title>
<style>
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:linear-gradient(180deg,#0b1220,#1e1b4b);
  color:#fff;
}
.header-block{
  width:100%;
  padding:16px 24px;
  background:rgba(255,255,255,0.05);
  backdrop-filter:blur(8px);
  text-align:center;
}
.header-block h1{
  margin:0 0 8px 0;
}
.stats{
  display:flex;
  gap:16px;
  justify-content:center;
  margin-bottom:8px;
  color:#94a3b8;
}
#rankBoard{
  width:90%;
  background:rgba(0,0,0,0.6);
  border-radius:12px;
  padding:0 0 12px 0;
  margin:12px auto;
  max-height:180px;
  overflow-y:auto;
}
#rankBoard h3{
  margin:0;
  padding:8px 12px;
  font-size:22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
#rankList{
  list-style:none;
  padding:0;
  margin:0;
}
#rankList li{
  padding:4px 12px;
}
main{
  display:flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap:16px;
  width: 100%;
  max-width:800px;
  padding-bottom:120px;
  margin:20px auto;
  text-align:center;
}
#clue{
  margin:16px 0;
  font-size:20px;
  color:#94a3b8;
}
.button-group{
  display:flex;
  gap:16px;
  justify-content:center;
  flex-wrap:wrap;
}
button{
  padding:10px 20px;
  margin:4px;
  font-size:18px;
  border:none;
  border-radius:10px;
  background:linear-gradient(90deg,#6366f1,#a78bfa);
  color:#fff;
  cursor:pointer;
}
button:disabled{
  opacity:0.6;
  cursor:not-allowed;
}
.result{
  font-size:20px;
  margin-top:8px;
  padding:6px 12px;
  border-radius:10px;
}
.result.good{
  background:rgba(34,197,94,0.15);
  color:#22c55e;
}
.result.bad{
  background:rgba(239,68,68,0.15);
  color:#ef4444;
}
footer{
  width:100%;
  padding:12px;
  background:rgba(0,0,0,0.3);
  backdrop-filter:blur(8px);
}
</style>
</head>
<body>

<div class="header-block">
<h1>é«˜é›„æ·é‹ é›™èªåŒè¡Œ ç£åŠ›è¿·å®® å¾©å¤æ¢éšª</h1>
<h2>Bilingual Kaohsiung Metro  Magnetic Maze Retro</h2>
<h1>å£èªªæŒ‘æˆ°</h1>
<div class="stats">åˆ†æ•¸ï¼š<span id="score">0</span> | ç­”å°ç‡ï¼š<span id="accuracy">0</span>% | æ™‚é–“ï¼š<span id="timer">0</span>s</div>
<div id="rankBoard">
<h3>ğŸ† æ’è¡Œæ¦œ</h3>
<ol id="rankList"></ol>
</div>
</div>

<main>
<div id="clue">è«‹æŒ‰ã€Œé–‹å§‹æŒ‘æˆ°ã€</div>
<div class="button-group">
<button id="startBtn">é–‹å§‹æŒ‘æˆ°</button>
<button id="recBtn">æŒ‰ä¸‹èªªè©±</button>
<button id="nextBtn">ä¸‹ä¸€é¡Œ</button>
<button id="playRef">æ’­æ”¾å–®å­—</button>
</div>
<div id="feedback"></div>
<div id="userSpeech"></div>
</main>

<footer>â±ï¸ å£èªªæŒ‘æˆ° â€” iPad å…¨è¢å¹•</footer>

<script>
const qa=[
  {prompt:'ç£éµ', answer:'magnet'},
  {prompt:'åŒ—æ¥µ', answer:'north pole'},
  {prompt:'å—æ¥µ', answer:'south pole'},
  {prompt:'æ¨é–‹', answer:'push away'},
  {prompt:'æ‹‰åœ¨ä¸€èµ·', answer:'pull together'}
];

let idx=0,score=0,totalCount=0,correctCount=0,isRecording=false,trialsLeft=5,startTime=0;
const scoreEl=document.getElementById('score');
const accuracyEl=document.getElementById('accuracy');
const timerEl=document.getElementById('timer');
const clue=document.getElementById('clue');
const feedback=document.getElementById('feedback');
const userSpeech=document.getElementById('userSpeech');
const recBtn=document.getElementById('recBtn');
const startBtn=document.getElementById('startBtn');
const nextBtn=document.getElementById('nextBtn');
const playRef=document.getElementById('playRef');
const rankList=document.getElementById('rankList');
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition=null;
let timerInterval=null;

if(SpeechRecognition){
  recognition=new SpeechRecognition();
  recognition.lang='en-US';
  recognition.interimResults=false;
  recognition.maxAlternatives=1;

  recognition.addEventListener('result', e=>{
    const txt=e.results[0][0].transcript.trim();
    const ref=qa[idx].answer.toLowerCase().replace(/ /g,'');
    const userInput=txt.toLowerCase().replace(/ /g,'');

    // é¡¯ç¤ºç³»çµ±åµæ¸¬æ–‡å­—
    userSpeech.innerHTML=`ä½ å”¸å‡ºä¾†è½èµ·ä¾†åƒ: <strong>${txt}</strong>`;

    let isCorrect = userInput===ref;
    totalCount++;
    trialsLeft--;
    if(isCorrect){
      correctCount++; score+=20;
      feedback.innerHTML=`<div class="result good">âœ… æ­£ç¢ºï¼</div>`;
      recBtn.disabled=true;
    } else {
      feedback.innerHTML=`<div class="result bad">âŒ éŒ¯èª¤! å‰©é¤˜æ¬¡æ•¸: ${trialsLeft}</div>`;
      if(trialsLeft>0){
        setTimeout(()=>speakWord(qa[idx].answer),500);
      } else {
        recBtn.disabled=true;
      }
    }
    updateStats();
  });

  recognition.addEventListener('end', ()=>{
    isRecording=false;
    recBtn.textContent='æŒ‰ä¸‹èªªè©±';
  });

  recognition.addEventListener('error', e=>{
    console.error(e);
    feedback.innerHTML='âš ï¸ èªéŸ³è¾¨è­˜å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡';
    isRecording=false;
    recBtn.textContent='æŒ‰ä¸‹èªªè©±';
  });
}else{
  recBtn.disabled=true;
  recBtn.textContent='æ­¤ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
}

function updateStats(){
  scoreEl.textContent=score;
  const rate=Math.floor(totalCount>0? (correctCount/totalCount*100):0);
  accuracyEl.textContent=rate;
}

function showQuestion(){
  const q=qa[idx];
  trialsLeft=5;
  feedback.innerHTML='';
  userSpeech.innerHTML='';
  recBtn.disabled=false;
  clue.innerHTML=`<div><strong>ä¸­æ–‡é¡Œæ˜¯:</strong> ${q.prompt}</div>
                  <div><strong>è‹±æ–‡é¡Œæ˜¯:</strong> ${q.answer}</div>`;
  speakWord(q.answer);
}

function speakWord(text){
  if('speechSynthesis' in window){
    const u=new SpeechSynthesisUtterance(text);
    u.lang='en-US';
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(u);
  }
}

startBtn.addEventListener('click', ()=>{
  idx=0; score=0; totalCount=0; correctCount=0; startTime=Date.now();
  updateStats();
  showQuestion();
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{ timerEl.textContent=Math.floor((Date.now()-startTime)/1000); },1000);
});

recBtn.addEventListener('click', ()=>{
  if(!recognition) return;
  if(!isRecording){
    recognition.start();
    isRecording=true;
    recBtn.textContent='éŒ„éŸ³ä¸­...å†æŒ‰ä¸€æ¬¡åœæ­¢';
  } else {
    recognition.stop();
  }
});

nextBtn.addEventListener('click', ()=>{
  idx++;
  if(idx>=qa.length){
    finishChallenge();
  } else {
    showQuestion();
  }
});

playRef.addEventListener('click', ()=>{ speakWord(qa[idx].answer); });

function saveRank(name,sc,t){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  recs.push({name,sc,t,date:new Date().toLocaleString()});
  recs.sort((a,b)=>b.sc-a.sc || a.t-b.t);
  localStorage.setItem('speaking_rank',JSON.stringify(recs.slice(0,15)));
  renderRank();
}

function renderRank(){
  const recs=JSON.parse(localStorage.getItem('speaking_rank')||'[]');
  rankList.innerHTML=recs.map((r,i)=>`<li>No.${i+1} ${r.name}: ${r.sc}åˆ† / ${r.t}s</li>`).join('');
}

function finishChallenge(){
  clearInterval(timerInterval);
  const totalTime=Math.floor((Date.now()-startTime)/1000);
  const name=prompt(`æŒ‘æˆ°å®Œæˆï¼åˆ†æ•¸: ${score} åˆ†ï¼Œæ™‚é–“: ${totalTime} ç§’\nè«‹è¼¸å…¥åå­—:`,'Player');
  saveRank(name||'åŒ¿å',score,totalTime);
  idx=0; score=0; totalCount=0; correctCount=0;
  timerEl.textContent=0;
  updateStats();
  showQuestion();
}

renderRank();
</script>
</body>
</html>
